\ProvidesPackage{khbiblatex}

\newif{\if@useampersand}
\newif{\if@shortbib}

\DeclareOption{ampersand}{\@useampersandtrue}
\DeclareOption{shortbib}{\@shortbibtrue}
\DeclareOption*{\PassOptionsToPackage{\CurrentOption}{biblatex}}
\ProcessOptions\relax

\RequirePackage{biblatex}

% make \citeyear and \citeyearpar into links
%\ifhyperref{
%    \DeclareCiteCommand{\citeyear}
%        {}{\bibhyperref{\printdate}}{\multicitedelim}{}
%    \DeclareCiteCommand{\citeyearpar}
%        {}{\mkbibparens{\bibhyperref{\printdate}}}{\multicitedelim}{}
%}{}

% replace "and" with "&" in citations
\if@useampersand
    \DeclareDelimFormat[textcite,parencite]{finalnamedelim}{%
        \ifnumgreater{\value{liststop}}{2}{\finalandcomma}{}%
        \addspace\&\space}
\else
\fi

% short references
\if@shortbib
    \AtEveryBibitem{%
        \clearname{editor}%
        \clearlist{publisher}%
        \clearlist{location}%
        \clearfield{isbn}%
        \clearfield{pages}%
    }
\else
\fi

% only print one of {doi, eprint, url}
\renewbibmacro*{doi+eprint+url}{%
    \iftoggle{bbx:doi}
    {\iffieldundef{url}{\printfield{doi}}{}}
    {}%
    \newunit\newblock
    \iftoggle{bbx:eprint}
    {\usebibmacro{eprint}}
    {}%
    \newunit\newblock
    \iftoggle{bbx:url}
    {\usebibmacro{url+urldate}}
    {}}
