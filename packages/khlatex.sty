%
% khlatex.sty
%
% Helper code for custom classes.
%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{khlatex}
	[2023/02/09 v0.1 Helper code for custom classes.]

\RequirePackage{etoolbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title formatting

% Default formatting
\newcommand{\@titlesize}{\LARGE}
\newcommand{\@pretitlesize}{\large}
\newcommand{\@subtitlesize}{\large}
\newcommand{\@keywordsize}{\large}
\newcommand{\@authorsize}{\large}
\newcommand{\@datesize}{\large}

\newcommand{\@titleweight}{\mdseries}
\newcommand{\@pretitleweight}{\mdseries}
\newcommand{\@subtitleweight}{\mdseries}
\newcommand{\@keywordweight}{\mdseries}
\newcommand{\@authorweight}{\mdseries}
\newcommand{\@dateweight}{\mdseries}

% space between items in title block
\newlength{\@titleblocksep}
\setlength{\@titleblocksep}{1em}

% reduce linespread in title in larger sizes
\newcommand{\@titlespread}{0.9}

% extra space after title, to balance large line height
\newlength{\@posttitleadjust}
\setlength{\@posttitleadjust}{0.3em}

\newlength{\@titleblocktmargin}
\setlength{\@titleblocktmargin}{2em}

\newlength{\@titleblockbmargin}
\setlength{\@titleblockbmargin}{2em}


% Options to change defaults

\DeclareOption{small}{
	\renewcommand{\@titlesize}{\Large}
	\renewcommand{\@pretitlesize}{\normalsize}
	\renewcommand{\@subtitlesize}{\normalsize}
	\renewcommand{\@keywordsize}{\normalsize}
	\renewcommand{\@authorsize}{\normalsize}
	\renewcommand{\@datesize}{\normalsize}
	\renewcommand{\@titlespread}{0.95}
	\setlength{\@posttitleadjust}{0.2em}}
\DeclareOption{tiny}{
	\renewcommand{\@titlesize}{\normalsize}
	\renewcommand{\@titleweight}{\bfseries}
	\renewcommand{\@pretitlesize}{\normalsize}
	\renewcommand{\@subtitlesize}{\normalsize}
	\renewcommand{\@keywordsize}{\normalsize}
	\renewcommand{\@authorsize}{\normalsize}
	\renewcommand{\@datesize}{\normalsize}
	\renewcommand{\@titlespread}{1.0}
	\setlength{\@posttitleadjust}{0em}}
\DeclareOption{compact}{
	\renewcommand{\@titleblocksep}{0.4em}
	\setlength{\@titleblocktmargin}{1em}
	\setlength{\@titleblockbmargin}{1em}}
\DeclareOption{tight}{
	\renewcommand{\@titleblocksep}{0.2em}
	\setlength{\@titleblocktmargin}{1em}
	\setlength{\@titleblockbmargin}{1em}}
\DeclareOption{nospace}{
	\renewcommand{\@titleblocksep}{0em}
	\setlength{\@titleblocktmargin}{0em}
	\setlength{\@titleblockbmargin}{1em}}
\ProcessOptions\relax


% Overwrite \title, \author, and \date commands to allow
% default title and blank author/date

\renewcommand{\@title}{Untitled}
\renewcommand{\title}[1]{\renewcommand{\@title}{#1}}

\renewcommand{\author}[1]{\def\@author{#1}}

\let\@date\relax
\renewcommand{\date}[1]{\def\@date{#1}}

% Add support for email, which appears after author
\newcommand{\email}[1]{\def\@email{#1}}

% Add support for subtitle, which appears between title and author
\newcommand{\subtitle}[1]{\def\@subtitle{#1}}

% Add support for "pretitle", which appears before title
\newcommand{\pretitle}[1]{\def\@pretitle{#1}}

% Add support for "short title" for use in header/footer/etc.
\newcommand{\shorttitle}[1]{\def\@shorttitle{#1}}

% Add support for keywords
\newcommand{\keywords}[1]{\def\@keywords{#1}}


% Access commands

\newcommand{\thetitle}{%
	\ifdefvoid{\@title}
		{\PackageError{khtitle}{No \textbackslash title given.}{}}
		{\@title}}
\newcommand{\thepretitle}{%
	\ifdefvoid{\@pretitle}
		{\PackageError{khtitle}{No \textbackslash pretitle given.}{}}
		{\@pretitle}}
\newcommand{\thesubtitle}{%
	\ifdefvoid{\@subtitle}
		{\PackageError{khtitle}{No \textbackslash subtitle given.}{}}
		{\@subtitle}}
\newcommand{\theauthor}{%
	\ifdefvoid{\@author}
		{\PackageError{khtitle}{No \textbackslash author given.}{}}
		{\@author}}
\newcommand{\theemail}{%
	\ifdefvoid{\@email}
		{\PackageError{khtitle}{No \textbackslash email given.}{}}
		{\@email}}
\newcommand{\thedate}{%
	\ifdefvoid{\@date}
		{\PackageError{khtitle}{No \textbackslash date given.}{}}
		{\@date}}
\newcommand{\theshorttitle}{%
	\ifdefvoid{\@shorttitle}
		{\PackageError{khtitle}{No \textbackslash shorttitle given.}{}}
		{\@shorttitle}}


% \titleblock
% Print the title, subtitle, author, and date, omitting the latter three if empty

\newcommand{\titleblock}{%
	\begingroup
	\centering
	\setlength{\parskip}{\@titleblocksep}
	\ifdefvoid{\@pretitle}{}{\@formatpretitle}
	\@formattitle
	\ifdefvoid{\@subtitle}{}{\@formatsubtitle}
	\ifdefvoid{\@author}{}{\@formatauthor}
	\ifdefvoid{\@email}{}{\@formatemail}
	\ifdefvoid{\@date}{}{\@formatdate}
	\ifdefvoid{\@keywords}{}{\@formatkeywords}
	\endgroup
}

\newcommand{\@formatpretitle}{%
	{\@pretitlesize\@pretitleweight\@pretitle \par}}
\newcommand{\@formattitle}{%
	{\@titlesize\linespread{\@titlespread}\@titleweight\@title \par}
	\vspace{\@posttitleadjust}}
\newcommand{\@formatsubtitle}{%
	{\@subtitlesize\@subtitleweight\@subtitle \par}}
\newcommand{\@formatkeywords}{%
	{Keywords: \@keywordsize\@keywordweight\@keywords \par}}
\newcommand{\@formatauthor}{%
	{\@authorsize\@authorweight\@author \par}}
\newcommand{\@formatemail}{%
	{\@authorsize\@authorweight\texttt\@email \par}}
\newcommand{\@formatdate}{%
	{\@datesize\@dateweight\@date \par}}


% Overwrite \maketitle

\renewcommand{\maketitle}{%
	\vspace*{\@titleblocktmargin}
	\titleblock
	\vspace{\@titleblockbmargin}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Font sizes

% Use proportional sizes for \large, etc. for 11pt
%  (the standard classes use the same sizes as 10pt).
% Also use consistent line spacing of 120%.
\DeclareOption{10pt}{
	\renewcommand\large{\@setfontsize\large{12}{14.4}}
	\renewcommand\Large{\@setfontsize\Large{14.4}{17.3}}
	\renewcommand\LARGE{\@setfontsize\LARGE{17.3}{20.7}}
	\renewcommand\huge{\@setfontsize\huge{20.7}{24.9}}
	\renewcommand\Huge{\@setfontsize\Huge{24.9}{29.9}}
}
\DeclareOption{11pt}{
	\renewcommand\large{\@setfontsize\large{13.2}{15.8}}
	\renewcommand\Large{\@setfontsize\Large{15.8}{19}}
	\renewcommand\LARGE{\@setfontsize\LARGE{19}{22.8}}
	\renewcommand\huge{\@setfontsize\huge{22.8}{27.4}}
	\renewcommand\Huge{\@setfontsize\Huge{27.4}{32.8}}
}
\DeclareOption{12pt}{
	\renewcommand\large{\@setfontsize\large{14.4}{17.3}}
	\renewcommand\Large{\@setfontsize\Large{17.3}{20.7}}
	\renewcommand\LARGE{\@setfontsize\LARGE{20.7}{24.9}}
	\renewcommand\huge{\@setfontsize\huge{24.9}{29.9}}
	\renewcommand\Huge{\@setfontsize\Huge{29.9}{35.8}}
}
\ProcessOptions\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Misc. adjustments

% preserve paragraph indentation and spacing in minipage
%\let\oldminipage\minipage
%\let\endoldminipage\endminipage
%\newlength{\currparskip}
%\newlength{\currparindent}
%\renewenvironment{minipage}{%
%    \setlength{\currparskip}{\parskip}
%    \setlength{\currparindent}{\parindent}
%    \newcommand{\@minipagerestore}{%
%        \setlength{\parskip}{\currparskip}
%        \setlength{\parindent}{\currparindent}
%    }%
%    \begin{oldminipage}%
%%    \setlength{\parskip}{\currparskip}
%%    \setlength{\parindent}{\currparindent}
%}{%
%    \end{oldminipage}%
%}
